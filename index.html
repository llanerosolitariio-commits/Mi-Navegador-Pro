<script type="module">
  // 1. Importaciones de Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, setDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // 2. CONFIGURACIÓN (REEMPLAZA ESTO CON TUS DATOS DE FIREBASE)
  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_PROYECTO.firebaseapp.com",
    projectId: "TU_PROYECTO",
    storageBucket: "TU_PROYECTO.appspot.com",
    messagingSenderId: "TU_ID",
    appId: "TU_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- SEGURIDAD: CONTRASEÑA ---
  // Cambia '1234' por la clave que tú quieras
  const CLAVE_ADMIN = '1234'; 

  window.toggleAdmin = () => {
    const modal = document.getElementById('adminModal');
    if (modal.style.display === 'flex') {
        modal.style.display = 'none';
    } else {
        const pass = prompt("Introduce la clave de Administrador:");
        if (pass === CLAVE_ADMIN) {
            modal.style.display = 'flex';
        } else {
            alert("Clave incorrecta");
        }
    }
  };

  // --- LÓGICA DE AVISOS ---
  window.saveInfo = async () => {
    const text = document.getElementById('adminInfoInput').value;
    try {
        await setDoc(doc(db, "ajustes", "avisoPrincipal"), { contenido: text });
        alert("Aviso actualizado correctamente");
    } catch (e) { alert("Error al guardar: " + e); }
  };

  // Escuchar aviso en tiempo real
  onSnapshot(doc(db, "ajustes", "avisoPrincipal"), (doc) => {
    if (doc.exists()) {
        const data = doc.data();
        document.getElementById('infoDisplay').innerText = data.contenido;
        document.getElementById('adminInfoInput').value = data.contenido;
    }
  });

  // --- LÓGICA DE REPERTORIOS ---
  window.addRepertorio = async () => {
    const title = document.getElementById('repTitle').value;
    const link = document.getElementById('repLink').value;
    if(!title || !link) return alert('Por favor, llena todos los campos');

    try {
        await addDoc(collection(db, "repertorios"), {
          title: title,
          link: link,
          fecha: Date.now()
        });
        document.getElementById('repTitle').value = '';
        document.getElementById('repLink').value = '';
        alert("Repertorio añadido");
    } catch (e) { alert("Error: " + e); }
  };

  window.deleteRep = async (id) => {
    if(confirm('¿Seguro que quieres eliminar este repertorio para todos los usuarios?')) {
        await deleteDoc(doc(db, "repertorios", id));
    }
  };

  // Escuchar repertorios en tiempo real (Ordenados por fecha)
  const q = query(collection(db, "repertorios"), orderBy("fecha", "desc"));
  onSnapshot(q, (snapshot) => {
    const grid = document.getElementById('repertorioGrid');
    grid.innerHTML = '';
    snapshot.forEach((doc) => {
      const rep = doc.data();
      grid.innerHTML += `
        <div class="card p-5 border border-indigo-50">
            <h3 class="font-bold text-lg text-indigo-900 mb-3">${rep.title}</h3>
            <div class="flex items-center justify-between">
                <a href="${rep.link}" target="_blank" class="bg-indigo-600 text-white px-5 py-2 rounded-lg text-xs font-bold hover:bg-indigo-700 transition">
                   <i class="fas fa-file-download mr-2"></i> VER REPERTORIO
                </a>
                <button onclick="deleteRep('${doc.id}')" class="text-gray-300 hover:text-red-500 transition-colors p-2">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </div>`;
    });
  });
</script>                <button onclick="toggleAdmin()" class="text-gray-500 text-2xl">&times;</button>
            </div>

            <div class="mb-8">
                <label class="block text-sm font-bold mb-2">Información Importante:</label>
                <textarea id="adminInfoInput" class="w-full border rounded-lg p-2 text-sm" rows="3" placeholder="Escribe el aviso principal..."></textarea>
                <button onclick="saveInfo()" class="mt-2 bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm w-full font-bold">Publicar Aviso</button>
            </div>

            <hr class="my-6">

            <div>
                <label class="block text-sm font-bold mb-2">Nuevo Repertorio:</label>
                <input type="text" id="repTitle" placeholder="Nombre del Domingo (ej: Domingo de Ramos)" class="w-full border rounded-lg p-2 mb-2 text-sm">
                <input type="text" id="repLink" placeholder="Link al PDF o Imagen (URL)" class="w-full border rounded-lg p-2 mb-4 text-sm">
                <button onclick="addRepertorio()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm w-full font-bold">Agregar al Domingo</button>
            </div>
        </div>
    </div>

    <script>
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', () => {
            renderInfo();
            renderRepertorios();
        });

        function toggleAdmin() {
            const modal = document.getElementById('adminModal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }

        // --- LÓGICA DE INFORMACIÓN ---
        function saveInfo() {
            const text = document.getElementById('adminInfoInput').value;
            localStorage.setItem('misaInfo', text);
            renderInfo();
            alert('Aviso actualizado');
        }

        function renderInfo() {
            const info = localStorage.getItem('misaInfo') || "No hay avisos recientes.";
            document.getElementById('infoDisplay').innerText = info;
            document.getElementById('adminInfoInput').value = info;
        }

        // --- LÓGICA DE REPERTORIOS ---
        function addRepertorio() {
            const title = document.getElementById('repTitle').value;
            const link = document.getElementById('repLink').value;
            if(!title || !link) return alert('Completa los campos');

            const reps = JSON.parse(localStorage.getItem('misaReps') || "[]");
            reps.push({ id: Date.now(), title, link });
            localStorage.setItem('misaReps', JSON.stringify(reps));
            
            document.getElementById('repTitle').value = '';
            document.getElementById('repLink').value = '';
            renderRepertorios();
        }

        function deleteRep(id) {
            if(confirm('¿Eliminar este repertorio?')) {
                let reps = JSON.parse(localStorage.getItem('misaReps') || "[]");
                reps = reps.filter(r => r.id !== id);
                localStorage.setItem('misaReps', JSON.stringify(reps));
                renderRepertorios();
            }
        }

        function renderRepertorios() {
            const reps = JSON.parse(localStorage.getItem('misaReps') || "[]");
            const grid = document.getElementById('repertorioGrid');
            grid.innerHTML = '';

            reps.forEach(rep => {
                grid.innerHTML += `
                    <div class="card p-5 relative">
                        <h3 class="font-bold text-lg text-indigo-900 mb-3">${rep.title}</h3>
                        <div class="flex gap-2">
                            <a href="${rep.link}" target="_blank" class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-full text-xs font-bold hover:bg-indigo-200 transition">Ver PDF / Imagen</a>
                            <button onclick="deleteRep(${rep.id})" class="text-red-300 hover:text-red-600 ml-auto"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>

